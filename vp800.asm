vprf800 ;convert pic from profi 8 0 0 mono            call    readfile2n ;считаем первые 64 сектора            ;проверки на размер            ld      hl,(loadadr2+6) ;hsize            ld      de,1            and     a            push    hl            sbc     hl,de            pop     hl            jp      c,viewprf80_e  ;exit if =1            ld      de,81            and     a            push    hl            sbc     hl,de            pop     hl            jp      nc,viewprf80_e   ;exit if >80            ld      (hsize),hl     ;if =80;            jr      z,viewprf80_2     ;if <80            ld      d,h            ld      e,l            ld      hl,80            and     a            sbc     hl,de            ld      d,h            ld      e,l            and     a            rr      l    ;div 2            ld      (shiftL),hl ;left tab            ld      hl,80            ld      de,(hsize)            and     a            sbc     hl,de            ld      de,(shiftL)            and     a            sbc     hl,de            ld      (shiftR),hl ;right tab;viewprf80_2            ld      hl,(loadadr2+2) ;vsize            ld      a,h            or      l            jp      z,viewprf80_e  ;exit if=0            ld      de,maxh ;проверка по высоте            and     a            push    hl            sbc     hl,de            pop     hl            jr      c,viewprf80_1            ld      hl,maxh ;если > строк то не выводим ни:ниеviewprf80_1            ld      (vsize),hl ;высота            ld      a,firstpag ;первая страница для картинки            ld      (curpicpag),a ;текущая страница            call    clearpag  ; вкл.чим страницу            ld      hl,(vsize) ;всего строк            ld      de,#c000 ;в окно            ;выравнивание по высоте            ld      bc,200            and     a            sbc     hl,bc            ld      bc,(vsize)            jr      nc,viewprf80_7            ld      hl,200            ld      (vsize),hl            and     a            sbc     hl,bc            and     a            rr      l            ld      a,l            or      a            jr      z,viewprf80_7            push    bc            ld      bc,80            ld      h,d            ld      l,eviewprf80_6            add     hl,bc            dec     a            jr      nz,viewprf80_6            ld      d,h            ld      e,l            pop     bcviewprf80_7            ld      hl,loadadr2+128            ;циклviewprf80_0            push    bc            push    hl            ld      hl,(shiftL)            add     hl,de            ld      d,h            ld      e,l            pop     hl            ld      bc,(hsize)            ldir    ;перенос строки            push    hl            ld      hl,(shiftR)            add     hl,de            ld      d,h            ld      e,l            pop     hl;проверка не надо ли подгрузить секторов            ld      a,#be            cp      h            jr      nc,viewprf80_2            ld      a,(fleftsec)            or      a            jr      z,viewprf80_2                       ;надо            ld      h,#80  ;на начало страницы            push    hl            push    de            xor     a            call    pag_on            call    readfile2n ;грузим            ld      a,(curpicpag)            call    pag_on            pop     de            pop     hlviewprf80_2            ;проверка не пора ли заполнять след страницу            push    hl            push    de            ld      bc,#c000+16000            ld      h,d            ld      l,e            and     a            sbc     hl,bc            pop     de            pop     hl            jr      c,viewprf80_3            ;пора на след страницу            push    hl            ;следу.щая страница для картинки            ld      a,(curpicpag)            inc     a            inc     a            ld      (curpicpag),a            call    clearpag            ld      de,#c000 ;начало страницы            pop     hlviewprf80_3            ;закрываем цикл            pop     bc            dec     bc            ld      a,b            or      c     ;след строка            jr      nz,viewprf80_0            ;коррекция числа страниц            xor     a ;минимум две            ld      hl,(vsize)            ld      bc,200 ;строкviewprf80_4            inc     a  ;увеличиваем кол заняты( страниц            inc     a            and     a            sbc     hl,bc            jr      z,viewprf80_5            jr      nc,viewprf80_4viewprf80_5            ld      (allpicpag),a ; всего страницviewprf80_e ;exit            call   showpic ;показать картинку            xor     a            call    pag_on            call    gmxpagoff            ret