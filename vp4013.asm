vprf4013 ;convert pic from profi 4 0 13            call    readfile2n ;считаем первые 64 сектора            ;проверки на размер            ld      hl,(loadadr2+6) ;hsize            ld      de,1            and     a            push    hl            sbc     hl,de            pop     hl            jp      c,vprf4013_e  ;exit if =1            ld      de,#a1            and     a            push    hl            sbc     hl,de            pop     hl            jp      nc,vprf4013_e   ;exit if >#a0            and     a            rr      l   ;делим на два            ld      (hsize),hl     ;if =80;            jr      z,vprf4013_2     ;if <80            ld      d,h            ld      e,l            ld      hl,80            and     a            sbc     hl,de            ld      d,h            ld      e,l            and     a            rr      l    ;div 2            ld      (shiftL),hl ;left tab            ld      hl,80            ld      de,(hsize)            and     a            sbc     hl,de            ld      de,(shiftL)            and     a            sbc     hl,de            ld      (shiftR),hl ;right tab            ld      hl,(loadadr2+2) ;vsize            ld      a,h            or      l            jp      z,vprf4013_e  ;exit if=0            ld      de,maxh ;проверка по высоте            and     a            push    hl            sbc     hl,de            pop     hl            jr      c,vprf4013_1            ld      hl,maxh ;если > строк то не выводим ни:ниеvprf4013_1            ld      (vsize),hl ;высота            ld      hl,loadadr2+10            call    mkpalp ;сделать палитру            call    mkpal256 ;вторую            ld      a,firstpag ;первая страница для картинки            ld      (curpicpag),a ;текущая страница            call    clearpag  ; вкл.чим страницу            ld      hl,(vsize) ;всего строк            ld      de,#c000 ;в окно            ;выравнивание по высоте            ld      bc,200            and     a            sbc     hl,bc            ld      bc,(vsize)            jr      nc,vprf4013_7            ld      hl,200            ld      (vsize),hl            and     a            sbc     hl,bc            and     a            rr      l            ld      a,l            or      a            jr      z,vprf4013_7            push    bc            ld      bc,80            ld      h,d            ld      l,evprf4013_6            add     hl,bc            dec     a            jr      nz,vprf4013_6            ld      d,h            ld      e,l            pop     bcvprf4013_7            ld      hl,loadadr2+128            ;циклvprf4013_0            push    bc            push    hl            ld      hl,(shiftL)            add     hl,de            ld      d,h            ld      e,l            pop     hl            ld      bc,(hsize)vprf4013_8            ;перенос строки            push    de         ;   push    bc            ldi            push    bc            ld      a,(curpicpag) ;страница атрибутов            inc     a            call    pag_on            pop     bc            pop     de            ld      a,(hl) ;коррекция атрибутов            push    hl            ld      hl,palet256            ld      l,a            ld      a,(hl)            pop     hl            ld      (de),a ;готов атрибут            inc     hl            inc     de         ;   dec     bc            push    bc            ld      a,(curpicpag) ;страница пикселей            call    pag_on            pop     bc            ld      a,b            or      c            jr      nz,vprf4013_8            push    hl            ld      hl,(shiftR)            add     hl,de            ld      d,h            ld      e,l            pop     hl;проверка не надо ли подгрузить секторов            ld      a,#be            cp      h            jr      nc,vprf4013_2            ld      a,(fleftsec)            or      a            jr      z,vprf4013_2                       ;надо            ld      h,#80  ;на начало страницы            push    hl            push    de            xor     a            call    pag_on            call    readfile2n ;грузим            ld      a,(curpicpag)            call    pag_on            pop     de            pop     hlvprf4013_2            ;проверка не пора ли заполнять след страницу            push    hl            push    de            ld      bc,#c000+16000            ld      h,d            ld      l,e            and     a            sbc     hl,bc            pop     de            pop     hl            jr      c,vprf4013_3            ;пора на след страницу            push    hl            ;следу.щая страница для картинки            ld      a,(curpicpag)            inc     a            inc     a            ld      (curpicpag),a            call    clearpag            ld      de,#c000 ;начало страницы            pop     hlvprf4013_3            ;закрываем цикл            pop     bc            dec     bc            ld      a,b            or      c     ;след строка            jp      nz,vprf4013_0            ;коррекция числа страниц            xor     a ;минимум две            ld      hl,(vsize)            ld      bc,200 ;строкvprf4013_4            inc     a  ;увеличиваем кол заняты( страниц            inc     a            and     a            sbc     hl,bc            jr      z,vprf4013_5            jr      nc,vprf4013_4vprf4013_5            ld      (allpicpag),a ; всего страницvprf4013_e ;exit            call   showpic ;показать картинку            xor     a            call    pag_on            call    gmxpagoff            retmkpalp  ;создание палитры        ;hl- палитра            ld      de,palette ;выходная палитра            ld      b,16 ;всего цветовmkpalpc            ld      a,(hl)            and     %00011100 ; R            cp      16            ld      a,0            jr      c,mkpalp01            ld      a,192mkpalp01            ld      (cr),a            ld      a,(hl)            and     %11100000 ; G            cp      128            ld      a,0            jr      c,mkpalp02            ld      a,192mkpalp02            ld      (cg),a            ld      a,(hl)            and     %00000011 ; B            cp      2            ld      a,0            jr      c,mkpalp03            ld      a,192mkpalp03            ld      (cb),a            ;теперь определим цвет            push    hl            ld      hl,paletzx            ld      c,7mkpalpn            push    hl            ld      a,(cr)            cp      (hl)            jr      nz,mkpalpn1            inc     hl            ld      a,(cg)            cp      (hl)            jr      nz,mkpalpn1            inc     hl            ld      a,(cb)            cp      (hl)            jr      nz,mkpalpn1            pop     hl            jr      mkpalpe ;выходmkpalpn1            pop     hl            inc     hl            inc     hl            inc     hl            dec     c            jr      nz,mkpalpnmkpalpe            pop     hl            ld      a,c            ld      (de),a ;получился цвет            ;закрытие цикла            inc     hl            inc     de            djnz    mkpalpc            ret