vatm ;convert pic from atm            call    readfile2n ;считаем первые 64 сектора            ;проверки на размер            ld      a,(loadadr2+#82) ;hsize            ld      l,a            ld      h,0            ld      de,1            and     a            push    hl            sbc     hl,de            pop     hl            jp      c,vatm_e  ;exit if =1            ld      de,#51            and     a            push    hl            sbc     hl,de            pop     hl            jp      nc,vatm_e   ;exit if >#50            and     a            ld      (hsize),hl            ;центровка по горизонтали            ld      d,h            ld      e,l            ld      hl,80            and     a            sbc     hl,de            ld      d,h            ld      e,l            and     a            rr      l    ;div 2            ld      (shiftL),hl ;left tab            ld      hl,80            ld      de,(hsize)            and     a            sbc     hl,de            ld      de,(shiftL)            and     a            sbc     hl,de            ld      (shiftR),hl ;right tab            ld      a,(loadadr2+#83) ;vsize            ld      l,a            ld      h,0            or      a            jp      z,vatm_e ;exit if=0            ld      de,201 ;проверка по высоте            and     a            push    hl            sbc     hl,de            pop     hl            jp      nc,vatm_e      ;      ld      hl,maxh ;если > строк то не выводим ни:ние;vatm_1            ld      (vsize),hl ;высота            ld      hl,loadadr2            call    mkpala ;сделать палитру            call    mkpal256 ; вторую палитру            ld      a,firstpag ;первая страница для картинки            ld      (curpicpag),a ;текущая страница            call    clearpag  ; вкл.чим страницу            ld      hl,(vsize) ;всего строк            ld      de,#c000 ;в окно            ;выравнивание по высоте            ld      bc,200            and     a            sbc     hl,bc            ld      bc,(vsize)            jr      nc,vatm_7            ld      hl,200        ;    ld      (vsize),hl            and     a            sbc     hl,bc            and     a            rr      l            ld      a,l            or      a            jr      z,vatm_7            ld      bc,80            ld      h,d            ld      l,evatm_6            add     hl,bc            dec     a            jr      nz,vatm_6            ld      d,h            ld      e,lvatm_7            ld      hl,loadadr2+#84            ld      bc,(hsize)            ld      (vatmde),de ;сохраним позицию            ;циклvatm_0            push    bc            push    de            push    hl            ld      hl,(shiftL)            add     hl,de            ld      d,h            ld      e,l            pop     hl            ld      bc,(vsize)vatm_8            ;перенос строки       ;     push    bc            ldi            push    hl            ld      hl,80-1  ;след строка            add     hl,de            ld      d,h            ld      e,l            pop     hl       ;     pop     bc        ;    dec     bc            ld      a,b            or      c            jr      nz,vatm_8;проверка не надо ли подгрузить секторов            ld      a,#be            cp      h            jr      nc,vatm_2            ld      a,(fleftsec) ;весь файл загружен            or      a            jr      z,vatm_2                       ;надо            ld      h,#80  ;на начало страницы            push    hl        ;    push    de            xor     a            call    pag_on            call    readfile2n ;грузим            ld      a,(curpicpag)            call    pag_on        ;    pop     de            pop     hlvatm_2            ;закрываем цикл            pop     de            inc     de  ;след столбец            pop     bc            dec     bc            ld      a,b            or      c     ;след строка            jp      nz,vatm_0            ;теперь атрибуты            xor     a            ld      (fatm),a  ;флаг            ld      a,(curpicpag)            inc     a    ;страница атриб            call    pag_on            ld      de,(vatmde) ;левый верхний угол            ld      bc,(hsize)            ;цикл по ширинеvatm_02            push    bc            push    de            push    hl            ld      hl,(shiftL) ;отступ слева            add     hl,de            ld      d,h            ld      e,l            pop     hl            ld      bc,(vsize)  ;цикл столбец            ld      (vatmbc),bcvatm_82            ;перенос столбца            ld      a,(fatm) ;флаг продолжения            or      a            jr      nz,vatm_82_0            ld      a,(hl) ;количество атрибута            ld      (vatma),a            ld      a,1            ld      (fatm),a            inc     hl  ;на атрибут            push    hl            ld      a,(hl)  ;цвет            ld      hl,palet256            ld      l,a            ld      a,(hl)            ld      (vatmcolor),a ;зпомнить            pop     hlvatm_82_0            ld      a,(vatmcolor)            ld      (de),a ;готов атрибут            push    hl            ld      hl,80  ;след строка            add     hl,de            ld      d,h            ld      e,l            pop     hl            ;проверка сколько еще атрибутов            ld      a,(vatma)            dec     a            ld      (vatma),a            jr      nz,vatm_822            inc     hl  ;на количество            xor     a            ld      (fatm),avatm_822            ;проверка на низ столбца            ld      bc,(vatmbc)            dec     bc            ld      (vatmbc),bc            ld      a,b            or      c            jr      z,vatm_821     ;на след столбец            jr      vatm_82 ;продолжить этотvatm_821;проверка не надо ли подгрузить секторов            ld      a,#be            cp      h            jr      nc,vatm_22            ld      a,(fleftsec) ;весь файл загружен            or      a            jr      z,vatm_22                       ;надо            ld      h,#80  ;на начало страницы            push    hl       ;     push    de            xor     a            call    pag_on            call    readfile2n ;грузим            ld      a,(curpicpag)            inc     a  ;            call    pag_on       ;     pop     de            pop     hlvatm_22            ;закрываем цикл            pop     de            inc     de  ;след столбец            pop     bc            dec     bc            ld      a,b            or      c     ;след строка            jp      nz,vatm_02            ;коррекция числа страниц            ld      a,2 ; две            ld      (allpicpag),a ; всего страницvatm_e ;exit            call    showpic ;показать картинку            xor     a            call    pag_on            call    gmxpagoff            retvatmde      dw      0vatmbc      dw      0vatma       db      0fatm        db      0vatmcolor   db      0mkpala  ;создание палитры        ;hl- палитра            ld      de,palette ;выходная палитра            ld      b,16 ;всего цветовmkpalac            ld      a,(hl)  ;G            cp      "2"            ld      a,0            jr      c,mkpala01            ld      a,192mkpala01            ld      (cg),a            inc     hl            ld      a,(hl)  ;R            cp      "2"            ld      a,0            jr      c,mkpala02            ld      a,192mkpala02            ld      (cr),a            inc     hl            ld      a,(hl)  ;B            cp      "2"            ld      a,0            jr      c,mkpala03            ld      a,192mkpala03            ld      (cb),a            ;теперь определим цвет            push    hl            ld      hl,paletzx            ld      c,7mkpalan            push    hl            ld      a,(cr)            cp      (hl)            jr      nz,mkpalan1            inc     hl            ld      a,(cg)            cp      (hl)            jr      nz,mkpalan1            inc     hl            ld      a,(cb)            cp      (hl)            jr      nz,mkpalan1            pop     hl            jr      mkpalae ;выходmkpalan1            pop     hl            inc     hl            inc     hl            inc     hl            dec     c            jr      nz,mkpalanmkpalae            pop     hl            ld      a,c            ld      (de),a ;получился цвет            ;закрытие цикла            inc     hl            inc     de            djnz    mkpalac            ret